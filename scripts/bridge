#!/bin/bash

source /usr/local/JSBach/conf/variables.conf

######################################################################
###  Funcions
######################################################################

fnc_iniciar()
{
	if ip link show br0 > /dev/null 2>&1; then
		echo "Ja està iniciat"
		exit 0
	fi

	echo "Iniciar"
	
	### FALTA ESTAT BRIDGE PER NO INICIAR SI JA ESTA FUNCIONANT
	
	##CREAR  BRIDGE part interna
	ip l a name br0 type bridge vlan_filtering 1
	ip l s dev br0 up
	
	for LINIA in $(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF" | grep -v '^#'); do
	    VLANID=$(echo "$LINIA"|cut -d';' -f2)
	    VLANIP=$(echo "$LINIA"|cut -d';' -f4)
	    ip l a l  br0 name br0.$VLANID  type vlan id $VLANID
	    ip l s dev br0.$VLANID up
	    ip a a dev br0.$VLANID $VLANIP
	done
	
	#Bridge part LAN
	bridge vlan del dev br0 vid 1 pvid untagged self
	for LINIA in $(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF" | grep -v '^#'); do
	 	NOM_IF=$(echo "$LINIA"|cut -d';' -f1)
 	 	VLAN_UNTAG=$(echo "$LINIA"|cut -d';' -f2)
	 	VLAN_TAG=$(echo "$LINIA"|cut -d';' -f3)
	 	ip l s dev $NOM_IF master br0
	 	ip l s dev $NOM_IF up
	 	bridge vlan del dev $NOM_IF vid 1 pvid untagged	
	 	if [ "$VLAN_UNTAG" != "0" ]; then
	 		bridge vlan add dev $NOM_IF vid $VLAN_UNTAG pvid untagged
	 		bridge vlan add dev br0 vid $VLAN_UNTAG self
	 	fi
	 	if [ "$VLAN_TAG" != "0" ]; then
	 		for CAMP in ${VLAN_TAG//,/ }; do
	 			bridge vlan add dev $NOM_IF vid $CAMP 
	 			bridge vlan add dev br0 vid $CAMP self
			done
	 	fi	 	 	
	done
}

fnc_aturar()
{
	if ! ip link show br0 > /dev/null 2>&1; then
		echo "Ja està parat"
		exit 0
	fi
	
	echo "Aturar"
	ip l d dev br0
}


fnc_configurar()
{	

	if [ $# -lt 1 ]; then
		echo "falta  mostrar, guardar, esborrar"
		exit 
	fi
	
	ARG_1=$1
	shift
			
	# Fem switch per executar la funció que toca
	case "$ARG_1" in
	  mostrar)
	    if [ "$1" == "vlan" ]; then
	    	cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep -v '^#'
	    fi
	    if [ "$1" == "bridge" ]; then
	    	cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"| grep -v '^#'
	    fi
	    ;;
	  guardar)
	  		
	    	OPCIO_2=$1
		shift 
		
	    	case "$OPCIO_2" in
	    		vlan)
	    		RESULTAT=$(grep -v ";$2;" "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF")
	    		echo "$RESULTAT" > "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"
	    		echo "$1;$2;$3;$4;" >> "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"
	    		;;
	    		bridge)
	    		if [ "$#" -lt "3" ]; then
	    			echo "falta nom_interfaç vid_untag (0 si no) vids-tag (0 si no)"
	    			exit
	    		fi
	    		RESULTAT=$(grep -v "$1;" "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF")
	    		echo "$RESULTAT" 
	    		echo "$RESULTAT" > "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"
	    		echo "$1;$2;$3;" >> "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"
	    		;;
	    		*)
		    	echo "Error"
		    	exit 1
		    	;;
		esac	    
	    ;; 
	  esborrar) 
	    if [ "$1" == "vlan" ]; then
	    	if [ "$2" -lt 3 ]; then
	    		echo "no es pot esborrar la vlan $2"
	    		exit 1
	    	fi	    	
	    	RESULTAT=$(grep -v ";$2;" "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF")
	    	echo "$RESULTAT" > "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"
	    	echo "$RESULTAT" 
	    fi
	    ;;
	  *)
	    echo "Error"
	    ;;
	esac	
}


fnc_estat()
{
	# --- Check if Bridge is Active (br0 exists) ---
	if ip link show br0 &>/dev/null; then
		IS_ACTIVE=1
	else
		IS_ACTIVE=0
	fi

	# --- If no arguments, show FULL STATUS (HTML) ---
	if [ $# -eq 0 ]; then
		# Estado General
		if [ "$IS_ACTIVE" -eq 1 ]; then
			echo "<div style='margin-bottom: 20px;'>"
			echo "  <span class='card-status status-active' style='font-size: 16px; padding: 6px 12px;'>✓ ACTIVAT</span>"
			echo "</div>"
			
			echo "<div style='display: grid; grid-template-columns: 1fr; gap: 24px;'>"
			
			# Card 1: Configured VLANs
			echo "  <div class='card' style='box-shadow: none; border: 1px solid #eee; background: #fff;'>"
			echo "    <div class='card-header' style='background: #f8f9fa; border-bottom: 1px solid #eee;'><h3>VLANs Configurades</h3></div>"
			echo "    <div class='card-body'>"
			echo "      <table style='width:100%'>"
			echo "        <tr><th>Nom</th><th>VID</th><th>Interfaç br0.X</th><th>IP / Subnet</th></tr>"
			for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"); do
				nom=$(echo "$linia"|cut -d';' -f1)
				vid=$(echo "$linia"|cut -d';' -f2)
				ip=$(echo "$linia"|cut -d';' -f4)
				
				# Check if subinterface exists
				IF_STATUS="<span style='color:#d93025'>✗ AVALL</span>"
				if ip link show "br0.$vid" &>/dev/null; then
					IF_STATUS="<span style='color:#188038'>✓ ACTIVA</span>"
				fi
				
				echo "        <tr><td>$nom</td><td>$vid</td><td>br0.$vid ($IF_STATUS)</td><td>$ip</td></tr>"
			done
			echo "      </table>"
			echo "    </div>"
			echo "  </div>"

			# Card 2: Interface Mapping (Tag/Untag)
			echo "  <div class='card' style='box-shadow: none; border: 1px solid #eee; background: #fff;'>"
			echo "    <div class='card-header' style='background: #f8f9fa; border-bottom: 1px solid #eee;'><h3>Associació d'Interfícies (Port Mapping)</h3></div>"
			echo "    <div class='card-body'>"
			echo "      <table style='width:100%'>"
			echo "        <tr><th>Interfaç Física</th><th>PVID (Untagged)</th><th>Tagged VIDs</th></tr>"
			for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"); do
				iface=$(echo "$linia"|cut -d';' -f1)
				pvid=$(echo "$linia"|cut -d';' -f2)
				vids=$(echo "$linia"|cut -d';' -f3)
				
				if [ "$pvid" == "0" ]; then pvid="-"; fi
				if [ "$vids" == "0" ]; then vids="-"; fi
				
				echo "        <tr><td><strong>$iface</strong></td><td>$pvid</td><td>$vids</td></tr>"
			done
			echo "      </table>"
			echo "    </div>"
			echo "  </div>"

			echo "</div>" # End Grid

		else
			echo "<div style='margin-bottom: 20px;'>"
			echo "  <span class='card-status status-inactive' style='font-size: 16px; padding: 6px 12px;'>✗ DESACTIVAT</span>"
			echo "  <p style='margin-top:10px; color:#666;'>El bridge no està creat. Totes les VLANs estan inactives.</p>"
			echo "</div>"
		fi
		
		# --- RAW DETAILS (Hidden/Expandable) ---
		echo "<details style='margin-top: 30px; border: 1px solid #eee; padding: 10px; border-radius: 4px;'>"
		echo "<summary style='cursor:pointer; color:#1a73e8; font-weight:500;'>Veure detalls tècnics (bridge vlan raw)</summary>"
		echo "<pre style='background:#f5f5f5; padding:10px; font-size:11px; overflow-x:auto;'>"
		bridge vlan show
		echo "---"
		ip -br link show br0
		echo "</pre>"
		echo "</details>"
		
		exit 0
	fi
	
	# --- Specific check for API (legacy) ---
	if [ "$1" == "estat" ] && [ "$IS_ACTIVE" -eq 1 ]; then
		echo "$ACTIVAT"
	elif [ "$1" == "estat" ]; then
		echo "$DESACTIVAT"
	fi
}


fnc_resum()
{
	if ip link show br0 &>/dev/null; then
		num_vlans=$(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF" | wc -l)
		num_ifaces=$(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF" | wc -l)
		echo "<strong>ACTIVAT</strong> ($num_vlans VLANs, $num_ifaces Port Mappings)"
	else
		echo "DESACTIVAT"
	fi
}

######################################################################
###  MAIN
######################################################################

MSG="falta [iniciar, aturar, configurar ,estat, resum]"

# Comprovem que hi hagi almenys un argument (la opció)
if [ $# -lt 1 ]; then
  echo "$MSG"
  exit 1
fi

OPCIO_1=$1
shift

# Fem switch per executar la funció que toca
case "$OPCIO_1" in
  iniciar)
    fnc_iniciar  $@
    ;;
  aturar)
    fnc_aturar	$@
    ;; 
  configurar) 
    fnc_configurar $@
    ;;
  estat) 
    fnc_estat $@
    ;;
  resum)
    fnc_resum $@
    ;;
  *)
    echo "$MSG"
    ;;
esac


