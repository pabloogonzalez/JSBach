#!/bin/bash

source /usr/local/JSBach/conf/variables.conf

######################################################################
###  Funcions
######################################################################

fnc_iniciar()
{
	# Check if already active BEFORE clearing rules
	if iptables -L ports_wls &>/dev/null; then
		echo "Ja està activat"
		exit 0
	fi

	fnc_aturar
	echo "Iniciar"	
		
	
	for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"); do
	    nom=$(echo "$linia"|cut -d';' -f1)
	    ip=$(echo "$linia"|cut -d';' -f3)
	    iptables -N $nom
	    iptables -A FORWARD -s $ip -j $nom	    
	done

	# --- Common Forwarding Logic ---
	iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT


	# --- INPUT Chains ---
	iptables -N IN_BASE
	iptables -N IN_ADMIN
	iptables -N IN_DMZ
	iptables -N IN_USERS

	# --- Common Logic ---
	iptables -A IN_BASE -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

	# --- INPUT Classification ---
	iptables -A INPUT -i lo -j ACCEPT
	iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
	iptables -A INPUT -s 10.0.1.0/24 -j IN_ADMIN
	iptables -A INPUT -s 10.0.2.0/24 -j IN_DMZ
	iptables -A INPUT -s 10.0.3.0/24 -j IN_USERS
	iptables -A INPUT -s 10.0.4.0/24 -j IN_USERS

	# --- VLAN Rules ---
	# VLAN Admin
	iptables -A IN_ADMIN -j IN_BASE
	iptables -A IN_ADMIN -j ACCEPT

	# VLAN DMZ (Default Drop)
	iptables -A IN_DMZ -j IN_BASE

	# VLAN Users (3 & 4)
	iptables -A IN_USERS -j IN_BASE
	iptables -A IN_USERS -p icmp -j ACCEPT
	iptables -A IN_USERS -p udp --dport 67:68 -j ACCEPT
	iptables -A IN_USERS -p udp --dport 53 -j ACCEPT
	iptables -A IN_USERS -p tcp --dport 53 -j ACCEPT

	# --- Chain: aislar ---
	iptables -N aislar
	iptables -A aislar -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
	iptables -A aislar -m conntrack --ctstate NEW -j DROP

	# --- Link aislar to VLANs ---
	# Check variables.conf for enabled isolation
	if [ "$AISLAR_VLAN_ADMIN" == "true" ] && iptables -L vlan_Admin &>/dev/null; then
		iptables -A vlan_Admin -d 10.0.1.0/24 -j aislar
	fi
	if [ "$AISLAR_VLAN_DMZ" == "true" ] && iptables -L vlan_DMZ &>/dev/null; then
		iptables -A vlan_DMZ -s 10.0.2.0/24 -j aislar
	fi
	
	iptables -N ports_wls
	for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS"); do
	    protocol=$(echo "$linia"|cut -d';' -f1)
	    num_port=$(echo "$linia"|cut -d';' -f2)
	    iptables -A ports_wls -p $protocol --dport $num_port -j ACCEPT	    
	done
	iptables -A ports_wls -j DROP

	# --- Default Policy ---
	iptables -P INPUT DROP

	
}

fnc_aturar()
{
	# Don't exit if already stopped, use return to continue if called from fnc_iniciar
	if ! iptables -L ports_wls &>/dev/null; then
		echo "Ja està parat"
		return 0
	fi

	echo "Aturar"
	iptables -F
	iptables -X
	iptables -P FORWARD ACCEPT
	iptables -P INPUT ACCEPT
	iptables -P OUTPUT ACCEPT	
	
	
	resultat=$($DIR/$PROJECTE/$DIR_SCRIPTS/enrutar estat)

	# Comprovem si conté la paraula "ACTIVAT"
	echo "$resultat" | grep -q "$ACTIVAT"

	if [ $? -eq 0 ]; then
		iptables -t nat -F 
		iptables -t nat -X
		$DIR/$PROJECTE/$DIR_SCRIPTS/enrutar iniciar
	else
		iptables -t nat -F 
		iptables -t nat -X
	fi	
}


fnc_configurar()
{	
	
	echo "Configuracio"
	echo "$(date) - fnc_configurar CALLED with args: $@" >> /tmp/tallafocs_debug.log
	
	ARG_1=$1
	shift
			
	# Fem switch per executar la funció que toca
	case "$ARG_1" in
	  desconnectar)
	        linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
	        nom=$( echo $linia | cut -d';' -f1)
	        vid=$( echo $linia | cut -d';' -f2)
	        if [ -z "$nom" ]; then
		    echo "Error no existeix vlan $1"
		else
		    iptables -F $nom
		        # IPs privilegiades
		     	for ipwls in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS"| grep "^$vid;"); do
			    ip=$(echo "$ipwls"|cut -d';' -f2)
			    mac=$(echo "$ipwls"|cut -d';' -f3)
			    iptables -A $nom   -s $ip -m mac --mac-source $mac -j ACCEPT 
			done

		    iptables -A $nom -j DROP
		fi
	  	;;
	  connectar)
	        linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
	        nom=$( echo $linia | cut -d';' -f1)
	        if [ -z "$nom" ]; then
		    	echo "Error no existeix vlan $1"
		else
			iptables -F $nom
		fi	        
	  	;;
	  connectar_port_wls)
	        linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
	        nom=$( echo $linia | cut -d';' -f1)
	        vid=$( echo $linia | cut -d';' -f2)
	        if [ -z "$nom" ]; then
		    	echo "Error no existeix vlan $1"
		else
			iptables -F $nom
		 	# IPs privilegiades
			for ipwls in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS"| grep "^$vid;"); do
			    ip=$(echo "$ipwls"|cut -d';' -f2)
			    mac=$(echo "$ipwls"|cut -d';' -f3)
			    iptables -A $nom   -s $ip -m mac --mac-source $mac -j ACCEPT 
			done
			
			iptables -A $nom -j ports_wls
			
		fi	        
	  	;;
	  afegir_port_wls)
		# $1: protocol, $2: port
		if [ -z "$1" ] || [ -z "$2" ]; then
			echo "Error: falta protocol o port"
		else
			# Add to file if not exists
			if ! grep -q "^$1;$2;" "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS"; then
				echo "$1;$2;" >> "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS"
				echo "Port $1 $2 afegit a la configuració"
				# Apply to iptables if chain exists
				if iptables -L ports_wls &>/dev/null; then
					iptables -I ports_wls 1 -p $1 --dport $2 -j ACCEPT
					echo "Regla iptables afegida"
				fi
			else
				echo "El port ja existeix"
			fi
		fi
		;;
	  eliminar_port_wls)
		# $1: protocol, $2: port
		if [ -z "$1" ] || [ -z "$2" ]; then
			echo "Error: falta protocol o port"
		else
			# Remove from file
			sed -i "/^$1;$2;/d" "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS"
			echo "Port $1 $2 eliminat de la configuració"
			# Remove from iptables if chain exists
			if iptables -L ports_wls &>/dev/null; then
				iptables -D ports_wls -p $1 --dport $2 -j ACCEPT 2>/dev/null
				echo "Regla iptables eliminada"
			fi
		fi
		;;
	  afegir_ip_wls)
		# $1: vid, $2: ip, $3: mac
		if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
			echo "Error: falta vid, ip o mac"
		else
			# Add to file if not exists
			if ! grep -q "^$1;$2;$3;" "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS"; then
				echo "$1;$2;$3;" >> "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS"
				echo "IP $2 ($3) afegida a la configuració (VID $1)"
				# Apply to iptables if chain for nomad exists
				linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
				nom=$( echo $linia | cut -d';' -f1)
				if [ -n "$nom" ] && iptables -L $nom &>/dev/null; then
					# If chain is in filtering state (contains DROP or ports_wls), add rule
					if iptables -C $nom -j DROP 2>/dev/null || iptables -C $nom -j ports_wls 2>/dev/null; then
						iptables -I $nom 1 -s $2 -m mac --mac-source $3 -j ACCEPT
						echo "Regla iptables afegida a la cadena $nom"
					fi
				fi
			else
				echo "L'entrada ja existeix"
			fi
		fi
		;;
	  eliminar_ip_wls)
		# $1: vid, $2: ip, $3: mac
		if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
			echo "Error: falta vid, ip o mac"
		else
			# Remove from file
			sed -i "/^$1;$2;$3;/d" "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS"
			echo "IP $2 ($3) eliminada de la configuració (VID $1)"
			# Remove from iptables if chain exists
			linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
			nom=$( echo $linia | cut -d';' -f1)
			if [ -n "$nom" ] && iptables -L $nom &>/dev/null; then
				iptables -D $nom -s $2 -m mac --mac-source $3 -j ACCEPT 2>/dev/null
				echo "Regla iptables eliminada de la cadena $nom"
			fi
		fi
		;;
	  activar_aislar)
		# $1: id (vlan id)
		linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
		nom=$( echo $linia | cut -d';' -f1)
		
		KEY=""
		if [ "$nom" == "vlan_Admin" ]; then KEY="AISLAR_VLAN_ADMIN"; fi
		if [ "$nom" == "vlan_DMZ" ]; then KEY="AISLAR_VLAN_DMZ"; fi
		
		if [ -n "$KEY" ]; then
			# Update conf
			if grep -q "^$KEY=" "$DIR/$PROJECTE/$DIR_CONF/variables.conf"; then
				sed -i "s/^$KEY=.*/$KEY=true/" "$DIR/$PROJECTE/$DIR_CONF/variables.conf"
			else
				echo "$KEY=true" >> "$DIR/$PROJECTE/$DIR_CONF/variables.conf"
			fi
			echo "Aïllament ACTIVAT per $nom"
			
			# Apply immediate if active
			if iptables -L $nom &>/dev/null; then
				# Ensure aislar chain exists
				if ! iptables -L aislar &>/dev/null; then
					iptables -N aislar
					iptables -A aislar -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
					iptables -A aislar -m conntrack --ctstate NEW -j DROP
				fi

				# Avoid dups
				iptables -D $nom -d 10.0.1.0/24 -j aislar 2>/dev/null
				iptables -D $nom -s 10.0.2.0/24 -j aislar 2>/dev/null
				
				if [ "$nom" == "vlan_Admin" ]; then iptables -A vlan_Admin -d 10.0.1.0/24 -j aislar; fi
				if [ "$nom" == "vlan_DMZ" ]; then iptables -A vlan_DMZ -s 10.0.2.0/24 -j aislar; fi
			fi
		else
			echo "Error: Aquesta VLAN no suporta aïllament"
		fi
		;;
	  desactivar_aislar)
		# $1: id (vlan id)
		linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
		nom=$( echo $linia | cut -d';' -f1)
		
		KEY=""
		if [ "$nom" == "vlan_Admin" ]; then KEY="AISLAR_VLAN_ADMIN"; fi
		if [ "$nom" == "vlan_DMZ" ]; then KEY="AISLAR_VLAN_DMZ"; fi
		
		if [ -n "$KEY" ]; then
			# Update conf
			if grep -q "^$KEY=" "$DIR/$PROJECTE/$DIR_CONF/variables.conf"; then
				sed -i "s/^$KEY=.*/$KEY=false/" "$DIR/$PROJECTE/$DIR_CONF/variables.conf"
			else
				echo "$KEY=false" >> "$DIR/$PROJECTE/$DIR_CONF/variables.conf"
			fi
			echo "Aïllament DESACTIVAT per $nom"
			
			# Remove immediate if active
			if iptables -L $nom &>/dev/null; then
				if [ "$nom" == "vlan_Admin" ]; then iptables -D vlan_Admin -d 10.0.1.0/24 -j aislar 2>/dev/null; fi
				if [ "$nom" == "vlan_DMZ" ]; then iptables -D vlan_DMZ -s 10.0.2.0/24 -j aislar 2>/dev/null; fi
			fi
		else
			echo "Error: Aquesta VLAN no suporta aïllament"
		fi
		;;
	  desconnectar_input)
		# $1: chain name (IN_ADMIN, IN_DMZ, IN_USERS)
		CHAIN=$1
		if iptables -L $CHAIN &>/dev/null; then
			iptables -F $CHAIN
			iptables -A $CHAIN -j DROP
			echo "$CHAIN desconnectat (Bloquejat)"
		else
			echo "Error: Cadena $CHAIN no existeix"
		fi
		;;
	  connectar_input)
		# $1: chain name
		CHAIN=$1
		if iptables -L $CHAIN &>/dev/null; then
			iptables -F $CHAIN
			
			# Re-apply default rules based on Chain Name
			case "$CHAIN" in
				IN_ADMIN)
					iptables -A IN_ADMIN -j IN_BASE
					iptables -A IN_ADMIN -j ACCEPT
					;;
				IN_DMZ)
					iptables -A IN_DMZ -j IN_BASE
					;;
				IN_USERS)
					iptables -A IN_USERS -j IN_BASE
					iptables -A IN_USERS -p icmp -j ACCEPT
					iptables -A IN_USERS -p udp --dport 67:68 -j ACCEPT
					;;
			esac
			echo "$CHAIN connectat (Regles per defecte restaurades)"
		else
			echo "Error: Cadena $CHAIN no existeix"
		fi
		;;
	  *)
	        echo "Error  argumnets conectar, desconectar, connectar_port_wls, afegir_port_wls, eliminar_port_wls, afegir_ip_wls, eliminar_ip_wls, activar_aislar, desactivar_aislar"
	        ;;
	esac	
	
}


fnc_estat()
{
	# --- Check if Firewall is Active ---
	if iptables -L ports_wls &>/dev/null; then
		IS_ACTIVE=1
	else
		IS_ACTIVE=0
	fi

	# --- If no arguments, show FULL STATUS (HTML) ---
	if [ $# -eq 0 ]; then
		
		# Estado General
		if [ "$IS_ACTIVE" -eq 1 ]; then
			echo "<div style='margin-bottom: 20px;'>"
			echo "  <span class='card-status status-active' style='font-size: 16px; padding: 6px 12px;'>✓ ACTIVAT</span>"
			echo "</div>"
			
			echo "<div style='display: grid; grid-template-columns: 1fr 1fr; gap: 20px;'>"
			
			# Column 1: VLAN Status (Rules)
			echo "<div>"
			echo "<h3>Estat de les VLANs (Traffic Forward)</h3>"
			echo "<table>"
			echo "<tr><th>VLAN</th><th>IP Origen</th><th>Estat Filtrant</th></tr>"
			
			for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"); do
				nom=$(echo "$linia"|cut -d';' -f1)
				ip=$(echo "$linia"|cut -d';' -f3)
				
				STATUS_TEXT="<span style='color:green'>OBERTA</span>"
				RULES_COUNT=$(iptables -L $nom 2>/dev/null | wc -l)
				
				if iptables -C $nom -j DROP 2>/dev/null; then
				   STATUS_TEXT="<span style='color:red'>TANCADA (DROP)</span>"
				elif iptables -C $nom -j ports_wls 2>/dev/null; then
				    STATUS_TEXT="<span style='color:orange'>FILTRANT (WLS)</span>"
				fi
				
				echo "<tr><td>$nom</td><td>$ip</td><td>$STATUS_TEXT</td></tr>"
			done
			echo "</table>"

			# --- NEW SECTION: INPUT Rules Status ---
			echo "<h3 style='margin-top:20px;'>Estat regles INPUT (Accés al router)</h3>"
			echo "<table>"
			echo "<tr><th>Zona</th><th>Política</th><th>Detalls</th><th>Accions</th></tr>"
			
			# Helper function for row generation (embedded logic)
			print_row() {
				CHAIN=$1
				NAME=$2
				DEFAULT_STATUS_HTML=$3
				DEFAULT_DETAILS=$4
				
				# Check if explicitly blocked (DROP present)
				# Note: IN_DMZ default is empty/IN_BASE, not DROP. IN_USERS default has accepts.
				# If we find explicit DROP and it's the only/main rule, it's blocked.
				# Simplified check: If chain contains DROP rule that is not the default implicit policy? 
				# Actually, my desconnectar logic adds "-j DROP".
				
				is_blocked=0
				if iptables -C $CHAIN -j DROP 2>/dev/null; then
					is_blocked=1
				fi

				if [ "$is_blocked" -eq 1 ]; then
					echo "<tr>"
					echo "<td>$NAME</td>"
					echo "<td><span style='color:red'>DESCONNECTAT</span></td>"
					echo "<td>Accés bloquejat manualment</td>"
					echo "<td><a href='/cgi-bin/tallafocs.cgi?comand=configurar+connectar_input+$CHAIN' class='btn small'>Connectar</a></td>"
					echo "</tr>"
				else
					echo "<tr>"
					echo "<td>$NAME</td>"
					echo "<td>$DEFAULT_STATUS_HTML</td>"
					echo "<td>$DEFAULT_DETAILS</td>"
					echo "<td><a href='/cgi-bin/tallafocs.cgi?comand=configurar+desconnectar_input+$CHAIN' class='btn small secondary' style='color:#d93025; border-color:#d93025;'>Desconnectar</a></td>"
					echo "</tr>"
				fi
			}

			if iptables -L IN_ADMIN &>/dev/null; then
				print_row "IN_ADMIN" "Admin (VLAN 1)" "<span style='color:green'>TOT PERMÈS</span>" "Accés complet"
			else
				echo "<tr><td>Admin (VLAN 1)</td><td>-</td><td>No actiu</td><td>-</td></tr>"
			fi

			if iptables -L IN_DMZ &>/dev/null; then
				print_row "IN_DMZ" "DMZ (VLAN 2)" "<span style='color:red'>BLOQUEJAT</span>" "Excepte establertes"
			else
				echo "<tr><td>DMZ (VLAN 2)</td><td>-</td><td>No actiu</td><td>-</td></tr>"
			fi

			if iptables -L IN_USERS &>/dev/null; then
				print_row "IN_USERS" "Usuaris (VLAN 3-4)" "<span style='color:orange'>LIMITAT</span>" "ICMP, DHCP (UDP 67-68)"
			else
				echo "<tr><td>Usuaris (VLAN 3-4)</td><td>-</td><td>No actiu</td><td>-</td></tr>"
			fi
			
			echo "</table>"
			echo "</div>"
			
			# Column 2: WLS Ports
			echo "<div>"
			echo "<h3>Ports WLS (Allowed)</h3>"
			echo "<table>"
			echo "<tr><th>Protocol</th><th>Port</th><th>Descripció</th></tr>"
			
			for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS"); do
				proto=$(echo "$linia"|cut -d';' -f1)
				port=$(echo "$linia"|cut -d';' -f2)
				desc=$(echo "$linia"|cut -d';' -f3) 
				if [ -z "$desc" ]; then desc="Servei Port $port"; fi
				
				echo "<tr><td>$proto</td><td>$port</td><td>$desc</td></tr>"
			done
			echo "</table>"
			echo "</div>"
			
			echo "</div>" # End Grid

		else
			echo "<div style='margin-bottom: 20px;'>"
			echo "  <span class='card-status status-inactive' style='font-size: 16px; padding: 6px 12px;'>✗ DESACTIVAT</span>"
			echo "  <p style='margin-top:10px; color:#666;'>El tallafocs està apagat. Tot el trànsit està permès (ACCEPT) o gestionat per defecte.</p>"
			echo "</div>"
		fi
		
		# --- RAW DETAILS (Hidden/Expandable) ---
		echo "<details style='margin-top: 30px; border: 1px solid #eee; padding: 10px; border-radius: 4px;'>"
		echo "<summary style='cursor:pointer; color:#1a73e8; font-weight:500;'>Veure detalls tècnics (iptables raw)</summary>"
		echo "<pre style='background:#f5f5f5; padding:10px; font-size:11px; overflow-x:auto;'>"
		iptables -nvL --line-numbers
		echo "</pre>"
		echo "</details>"
		
		exit 0
	fi
	
	# --- Check Specific VLAN Status (Legacy/API usage) ---
	linia=$(cat "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_CONF"| grep ";$1;" )
	nom=$( echo $linia | cut -d';' -f1)
	if [ -z "$nom" ]; then
		echo "Error no existeix vlan $1"
	else
		if iptables -C $nom -j DROP 2>/dev/null; then
			echo "DESCONNECTADA"
		else
			echo "CONNECTADA"
		fi 
	fi
}


fnc_resum()
{
	if iptables -L ports_wls &>/dev/null; then
		num_ports=$(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$PORTS_WLS" | wc -l)
		num_ips=$(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$IPS_WLS" | wc -l)
		echo "<strong>ACTIVAT</strong> ($num_ports ports, $num_ips IPs priv.)"
	else
		echo "DESACTIVAT"
	fi
}

######################################################################
###  EBTABLES FUNCTIONS
######################################################################

fnc_ebtables_init()
{
	echo "Inicialitzant Ebtables..."
	
	# Default Policy
	ebtables -P FORWARD ACCEPT
	
	# Flush specific rules if needed, or just ensure we don't duplicate
	# ideally we flush FORWARD chain or specific user chain?
	# For safety, we can just flush FORWARD if we own it, but better be careful.
	# User request implies specific rules. 
	
	# We will rely on our state file to re-apply enabled rules
	EBTABLES_STATE="$DIR/$PROJECTE/$DIR_CONF/ebtables_state.conf"
	touch "$EBTABLES_STATE"

	# Iterate over known interfaces from bridge_if.conf
	# Format: interface name is first field
	for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"); do
		iface=$(echo "$linia" | cut -d';' -f1)
		
		# Check if enabled in state file
		if grep -q "^$iface;ENABLED" "$EBTABLES_STATE"; then
			# Apply rule if not exists
			# Rule: ebtables -A FORWARD -i $iface ! -o br0 -j DROP
			if ! ebtables -L FORWARD | grep -q "\-i $iface -o ! br0 -j DROP"; then
				ebtables -A FORWARD -i $iface ! -o br0 -j DROP
				echo "Regla aplicada per $iface"
			fi
		fi
	done
}

fnc_ebtables_aturar()
{
	echo "Aturant Ebtables (Regles)..."
	# Remove our specific rules. 
	# We iterate interfaces and remove the specific drop rule
	for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"); do
		iface=$(echo "$linia" | cut -d';' -f1)
		# Try delete until error
		while ebtables -D FORWARD -i $iface ! -o br0 -j DROP 2>/dev/null; do :; done
	done
	echo "Regles ebtables netejades."
}

fnc_ebtables_toggle()
{
	# $1: interface name
	iface=$1
	if [ -z "$iface" ]; then echo "Error: Falta interfície"; return; fi

	EBTABLES_STATE="$DIR/$PROJECTE/$DIR_CONF/ebtables_state.conf"
	touch "$EBTABLES_STATE"
	
	# Check current state in file
	if grep -q "^$iface;ENABLED" "$EBTABLES_STATE"; then
		# IS ENABLED -> DISABLE
		sed -i "/^$iface;ENABLED/d" "$EBTABLES_STATE"
		# Remove rule
		while ebtables -D FORWARD -i $iface ! -o br0 -j DROP 2>/dev/null; do :; done
		echo "DESACTIVAT"
	else
		# IS DISABLED -> ENABLE
		echo "$iface;ENABLED" >> "$EBTABLES_STATE"
		# Add rule
		ebtables -A FORWARD -i $iface ! -o br0 -j DROP
		echo "ACTIVAT"
	fi
}

fnc_ebtables_status()
{
	EBTABLES_STATE="$DIR/$PROJECTE/$DIR_CONF/ebtables_state.conf"
	touch "$EBTABLES_STATE"
	
	echo "<h3>Estat Regles Ebtables (L2 Firewall)</h3>"
	echo "<p class='subtitle'>Evita l'enviament de paquets entre interfícies físiques (Aïllament L2).</p>"
	echo "<table class='table'>"
	echo "<thead><tr><th>Interfície</th><th>Estat</th><th>Acció</th></tr></thead>"
	echo "<tbody>"
	
	for linia in $(grep -v '#' "$DIR/$PROJECTE/$DIR_CONF/$BRIDGE_IF"); do
		iface=$(echo "$linia" | cut -d';' -f1)
		
		# Check if enabled in file (Persistence)
		is_enabled_file=0
		if grep -q "^$iface;ENABLED" "$EBTABLES_STATE"; then is_enabled_file=1; fi
		
		# Check actual system state
		is_active_sys=0
		if ebtables -L FORWARD | grep -q "\-i $iface -o ! br0 -j DROP"; then is_active_sys=1; fi
		
		# Determine Display Status
		if [ $is_enabled_file -eq 1 ]; then
			STATUS_HTML="<span class='badge badge-success'>ACTIVAT</span>"
			BTN_TXT="Desactivar"
			BTN_CLASS="btn-danger"
		else
			STATUS_HTML="<span class='badge badge-secondary'>DESACTIVAT</span>"
			BTN_TXT="Activar"
			BTN_CLASS="btn-primary"
		fi
		
		# Warning if mismatch
		if [ $is_enabled_file -eq 1 ] && [ $is_active_sys -eq 0 ]; then
			STATUS_HTML="$STATUS_HTML <span style='font-size:0.8em; color:orange;'>(No aplicat)</span>"
		fi
		
		echo "<tr>"
		echo "<td><strong>$iface</strong></td>"
		echo "<td>$STATUS_HTML</td>"
		echo "<td><a href='ebtables.cgi?action=toggle&iface=$iface' class='btn $BTN_CLASS btn-sm'>$BTN_TXT</a></td>"
		echo "</tr>"
	done
	
	echo "</tbody>"
	echo "</table>"

	# --- RAW DETAILS (Hidden/Expandable) ---
	echo "<details style='margin-top: 30px; border: 1px solid #eee; padding: 10px; border-radius: 4px;'>"
	echo "<summary style='cursor:pointer; color:#1a73e8; font-weight:500;'>Veure detalls tècnics (ebtables raw)</summary>"
	echo "<pre style='background:#f5f5f5; padding:10px; font-size:11px; overflow-x:auto;'>"
	ebtables -L --Lc --Ln
	echo "</pre>"
	echo "</details>"
}


######################################################################
###  MAIN
######################################################################

MSG="falta [iniciar, aturar, configurar ,estat, resum, ebtables_init, ebtables_aturar, ebtables_toggle, ebtables_status]"

# Comprovem que hi hagi almenys un argument (la opció)
if [ $# -lt 1 ]; then
  echo "$MSG"
  exit 1
fi

OPCIO_1=$1
shift

# Fem switch per executar la funció que toca
case "$OPCIO_1" in
  iniciar)
    fnc_iniciar  $@
    ;;
  aturar)
    fnc_aturar	$@
    ;; 
  configurar) 
    fnc_configurar $@
    ;;
  estat) 
    fnc_estat $@
    ;;
  resum)
    fnc_resum $@
    ;;
  ebtables_init)
    fnc_ebtables_init $@
    ;;
  ebtables_aturar)
    fnc_ebtables_aturar $@
    ;;
  ebtables_toggle)
    fnc_ebtables_toggle $@
    ;;
  ebtables_status)
    fnc_ebtables_status $@
    ;;
  *)
    echo "$MSG"
    ;;
esac


